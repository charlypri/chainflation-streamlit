import streamlit as st
import pandas as pd
import plotly.express as px
from dotenv import load_dotenv
from functions import *
import folium
from streamlit_folium import st_folium
import plotly.express as px
import requests
from streamlit_option_menu import option_menu
import plotly.graph_objects as go
from datetime import datetime, time, date

load_dotenv()

# Configuraci√≥n b√°sica de Streamlit
st.set_page_config(page_title="Chainflation - Dashboard", page_icon="üìä", layout="wide")


@st.cache_resource(hash_funcs={"pymongo.mongo_client.MongoClient": id})
def loadData():
    # get product prices
    prod_prices = getProductPrices()

    category_infl = getCategoriesInflation()
    return prod_prices, category_infl


with st.sidebar:
    menu = option_menu(
        "Explora los Datos",
        ["General", "Precios de Alimentos", "Precios de Vivienda"],
        icons=["", "gear", "bi-joystick"],
        menu_icon="",
        default_index=0,
    )

prod_prices, category_infl = loadData()
alimentacion_df = prod_prices["alimentacion"]
vivienda_df = prod_prices["vivienda"]
energia_df = prod_prices["energia"]

alimentacion_df["producto"] = alimentacion_df["producto"].str.capitalize()

vivienda_df = vivienda_df[vivienda_df["provincia"] != "Espa√±a"]
vivienda_df["producto"] = vivienda_df["producto"].str.capitalize()

if menu == "General":
    # Par√°metros
    st.title("Inflaci√≥n en Espa√±a - Chainflation")
    st.divider()

    time_periods = {
        "3 month": date.today() - timedelta(days=91),
        "6 Months": date.today() - timedelta(days=180),
        "1 year": date.today() - timedelta(days=365),
        "5 years": date.today() - timedelta(days=720),
    }
    col1, col2, col3 = st.columns(3)
    with col1:
        date_range = st.selectbox(label="Period", options=time_periods.keys(), index=2)
    with st.container(border=True):

        fig = go.Figure()
        for category in category_infl["category"].unique():
            category_data = category_infl[
                category_infl["category"] == category
            ].sort_values("fecha")

            category_data = category_data[
                category_data["fecha"].dt.date > time_periods[date_range]
            ]

            fig.add_trace(
                go.Scatter(
                    x=category_data["fecha"],
                    y=category_data["inflation"],
                    mode="lines+markers",
                    name=category.capitalize(),
                )
            )

        fig.update_layout(
            xaxis_title="Fecha",
            yaxis_title="Inflaci√≥n (%)",
            height=600,
            title="Inflaci√≥n YoY de Chainflation",
            legend=dict(
                font=dict(
                    size=30,
                )
            ),
            xaxis=dict(
                title="Fecha",
                titlefont=dict(size=30),  # Tama√±o del t√≠tulo del eje X
                tickfont=dict(size=25),  # Tama√±o de las etiquetas del eje X
            ),
            yaxis=dict(
                title="Inflaci√≥n (%)",
                titlefont=dict(size=30),  # Tama√±o del t√≠tulo del eje Y
                tickfont=dict(size=25),  # Tama√±o de las etiquetas del eje Y
            ),
        )
        st.plotly_chart(fig)

    # Crear columnas para los m√°ximos

    # Obtener categor√≠as y asegurar que "Total" est√© primero
    categories = category_infl["category"].unique()
    sorted_categories = sorted(categories, key=lambda x: (x != "total", x))

    col1, col2, col3, col4 = st.columns(4)
    with col2:
        st.subheader("M√°ximos registrados")
        with st.container(border=True):
            # Calcular y mostrar m√°ximos por categor√≠a
            for i, category in enumerate(sorted_categories):
                category_data = category_infl[category_infl["category"] == category]

                # Mes con la inflaci√≥n m√°s alta
                max_inflation_row = category_data.loc[
                    category_data["inflation"].idxmax()
                ]
                max_month = max_inflation_row["fecha"].strftime("%B %Y")
                max_value = max_inflation_row["inflation"]

                # with [col1, col2, col3, col4][i % 4]:  # Distribuir en 4 columnas
                with st.container(border=True):
                    st.metric(
                        label=f"{category.capitalize()}",
                        value=max_month,
                        delta=f"{max_value:.2f}%",
                        delta_color="inverse",
                    )

    with col3:
        st.subheader("M√≠nimos registrados")
        with st.container(border=True):
            # Calcular y mostrar m√≠nimos por categor√≠a
            for i, category in enumerate(sorted_categories):
                category_data = category_infl[category_infl["category"] == category]

                # Mes con la inflaci√≥n m√°s baja
                min_inflation_row = category_data.loc[
                    category_data["inflation"].idxmin()
                ]
                min_month = min_inflation_row["fecha"].strftime("%B %Y")
                min_value = min_inflation_row["inflation"]
                with st.container(border=True):
                    st.metric(
                        label=f"{category.capitalize()}",
                        value=min_month,
                        delta=f"{min_value:.2f}%",
                        delta_color="inverse",
                    )


if menu == "Precios de Alimentos":
    # An√°lisis de precios de alimentos
    st.title("üìä An√°lisis de Precios de Alimentos")
    st.divider()

    # Columna para los filtros principales
    col1, col2, col3 = st.columns([1, 1, 1])
    with col1:
        supermercados = alimentacion_df["fuente"].unique()
        supermercado_seleccionado = st.selectbox(
            "Selecciona un supermercado", supermercados
        )
    with col2:
        fecha_inicio = st.date_input("Fecha de inicio", pd.to_datetime("2024-01-01"))
    with col3:
        fecha_fin = st.date_input("Fecha de fin", pd.to_datetime("2024-12-31"))

    # Filtrar los datos por supermercado y por rango de fechas
    df_filtrado = alimentacion_df[
        (alimentacion_df["fuente"] == supermercado_seleccionado)
        & (alimentacion_df["fecha"] >= pd.to_datetime(fecha_inicio))
        & (alimentacion_df["fecha"] <= pd.to_datetime(fecha_fin))
    ]

    # 1. Producto m√°s caro y m√°s barato
    producto_mas_caro = df_filtrado.loc[df_filtrado["precio_referencia"].idxmax()]
    producto_mas_barato = df_filtrado.loc[df_filtrado["precio_referencia"].idxmin()]

    # 2. Producto que m√°s ha aumentado y disminuido en valor
    df_filtrado["diferencia"] = (
        df_filtrado.groupby("producto")["precio_referencia"].diff().fillna(0)
    )
    producto_mayor_aumento = df_filtrado.loc[df_filtrado["diferencia"].idxmax()]
    producto_mayor_disminucion = df_filtrado.loc[df_filtrado["diferencia"].idxmin()]

    # 3. Productos que m√°s han subido y bajado en la √∫ltima semana
    ultima_semana = df_filtrado[
        df_filtrado["fecha"] >= (df_filtrado["fecha"].max() - pd.Timedelta(days=14))
    ]
    ultima_semana["variacion"] = (
        ultima_semana.groupby("producto")["precio_referencia"]
        .pct_change(periods=14)
        .fillna(0)
    )

    # Seleccionar los 5 que m√°s subieron y los 5 que m√°s bajaron
    top_aumento = ultima_semana.nlargest(5, "variacion")
    top_disminucion = ultima_semana.nsmallest(5, "variacion")

    # Concatenar para un gr√°fico comparativo
    top_variacion = pd.concat([top_aumento, top_disminucion])

    # 4. Comparaci√≥n de precios entre supermercados
    precios_promedio = (
        alimentacion_df.groupby(["fuente", "producto"])["precio_referencia"]
        .mean()
        .reset_index()
    )
    productos_mas_baratos = precios_promedio.loc[
        precios_promedio.groupby("producto")["precio_referencia"].idxmin()
    ]

    col1, col2 = st.columns([2, 4])
    with col1:
        with st.container(border=True):
            # Visualizaci√≥n de las m√©tricas y explicaciones
            st.header(f"Supermercado: {supermercado_seleccionado}")
            st.markdown("")

    # M√©tricas con tarjetas (Cards) explicadas
    st.markdown("")
    st.markdown("")
    st.subheader(" üè∑Ô∏è Productos clave para el supermercado seleccionado", divider="blue")
    st.caption(
        "Estas m√©tricas muestran informaci√≥n sobre los productos m√°s caros, baratos y aquellos que han cambiado m√°s de precio en el supermercado seleccionado."
    )
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        with st.container(border=True):
            st.metric(
                label="Producto m√°s caro",
                value=f"{producto_mas_caro['producto']}",
                delta=f"{producto_mas_caro['precio_referencia']:.2f}‚Ç¨",
                help=f"Este es el producto m√°s caro en {supermercado_seleccionado} durante el periodo seleccionado.",
            )

    with col2:
        with st.container(border=True):
            st.metric(
                label="Producto m√°s barato",
                value=f"{producto_mas_barato['producto']}",
                delta=f"{producto_mas_barato['precio_referencia']:.2f}‚Ç¨",
                help=f"Este es el producto m√°s barato en {supermercado_seleccionado} en el mismo periodo.",
            )

    with col3:
        with st.container(border=True):
            st.metric(
                label="Mayor aumento de precio",
                value=f"{producto_mayor_aumento['producto']}",
                delta=f"{producto_mayor_aumento['diferencia']:.2f}‚Ç¨",
                help="Este producto ha tenido el mayor aumento en su precio durante el periodo seleccionado.",
            )
    with col4:
        with st.container(border=True):
            st.metric(
                label="Mayor disminuci√≥n de precio",
                value=f"{producto_mayor_disminucion['producto']}",
                delta=f"{producto_mayor_disminucion['diferencia']:.2f}‚Ç¨",
                help="Este producto ha tenido el mayor disminuci√≥n en su precio durante el periodo seleccionado.",
            )

    # Gr√°fico interactivo con Plotly: evoluci√≥n de precios en el tiempo
    st.markdown("")
    st.markdown("")
    st.subheader(
        "üìà Evoluci√≥n de precios de productos en el supermercado", divider="blue"
    )
    fig = px.line(
        df_filtrado,
        x="fecha",
        y="precio_referencia",
        color="producto",
        title="Evoluci√≥n de precios por producto",
        labels={"precio_referencia": "Precio (‚Ç¨)"},
    )
    st.plotly_chart(fig, use_container_width=True)

    # Gr√°fico de barras para los 5 productos que m√°s han subido y bajado
    st.subheader(
        " üìä Productos que m√°s han subido y bajado en la √∫ltima semana", divider="blue"
    )
    fig_variacion = px.bar(
        top_variacion,
        x="producto",
        y="variacion",
        color="variacion",
        title="Top 5 productos que m√°s han subido y bajado en la √∫ltima semana",
        labels={"variacion": "Cambio porcentual (%)", "producto": "Producto"},
        color_continuous_scale="agsunset",
    )
    fig_variacion.update_layout(
        barmode="group", yaxis_title="Cambio porcentual (%)", xaxis_title="Producto"
    )
    st.plotly_chart(fig_variacion, use_container_width=True)

    st.markdown("")
    # Comparaci√≥n de productos m√°s baratos entre supermercados
    st.subheader(
        " üõí Comparaci√≥n de productos m√°s baratos entre supermercados", divider="blue"
    )
    # Graficar comparativa de precios m√°s baratos entre supermercados
    fig_bar = px.bar(
        productos_mas_baratos,
        x="producto",
        y="precio_referencia",
        color="fuente",
        title="Comparativa de productos m√°s baratos entre supermercados",
        labels={"precio_referencia": "Precio (‚Ç¨)", "producto": "Producto"},
        barmode="group",
    )
    fig_bar.update_layout(xaxis_title="Producto", yaxis_title="Precio (‚Ç¨)")
    col1, col2 = st.columns(2)
    with col1:
        st.plotly_chart(fig_bar, use_container_width=True)

    # Pie chart con hueco en el centro y con valores
    fig_pie = px.pie(
        productos_mas_baratos,
        values="precio_referencia",
        names="fuente",
        title="Distribuci√≥n de productos m√°s baratos por supermercado",
        hole=0.4,
    )
    fig_pie.update_traces(textinfo="percent+label")
    with col2:
        st.plotly_chart(fig_pie, use_container_width=True)

elif menu == "Precios de Vivienda":
    # Filtro de Venta o Alquiler
    st.title("üè° An√°lisis de Precios de Vivienda por Provincias")
    st.divider()

    # Filtro de fechas
    col1, col2, col3 = st.columns([1, 2, 2])
    with col1:
        producto_tipo = st.radio(
            "Selecciona si es venta o alquiler", ["Venta", "Alquiler"]
        )
    with col2:
        fecha_inicio_vivienda = st.date_input(
            "Fecha de inicio", pd.to_datetime("2024-01-01")
        )
    with col3:
        fecha_fin_vivienda = st.date_input("Fecha de fin", pd.to_datetime("2024-12-31"))

        # Filtrar los datos por tipo de producto (venta o alquiler) y rango de fechas
    df_vivienda_filtrado = vivienda_df[
        (vivienda_df["producto"] == producto_tipo)
        & (vivienda_df["fecha"] >= pd.to_datetime(fecha_inicio_vivienda))
        & (vivienda_df["fecha"] <= pd.to_datetime(fecha_fin_vivienda))
    ]

    # 1. Provincia m√°s cara y m√°s barata
    provincia_mas_cara = df_vivienda_filtrado.loc[
        df_vivienda_filtrado["precio"].idxmax()
    ]
    provincia_mas_barata = df_vivienda_filtrado.loc[
        df_vivienda_filtrado["precio"].idxmin()
    ]

    # 2. Provincia que m√°s ha aumentado y disminuido en valor
    df_vivienda_filtrado["diferencia"] = (
        df_vivienda_filtrado.groupby("provincia")["precio"].diff().fillna(0)
    )
    provincia_mayor_aumento = df_vivienda_filtrado.loc[
        df_vivienda_filtrado["diferencia"].idxmax()
    ]
    provincia_mayor_disminucion = df_vivienda_filtrado.loc[
        df_vivienda_filtrado["diferencia"].idxmin()
    ]

    # 3. Provincias con m√°s variaci√≥n en los √∫ltimos 30 d√≠as
    ultimo_mes_vivienda = df_vivienda_filtrado[
        df_vivienda_filtrado["fecha"]
        >= (df_vivienda_filtrado["fecha"].max() - pd.Timedelta(days=30))
    ]
    ultimo_mes_vivienda["variacion"] = (
        ultimo_mes_vivienda.groupby("provincia")["precio"].pct_change().fillna(0)
    )

    # Seleccionar las 5 provincias que m√°s subieron y m√°s bajaron
    top_aumento_provincias = ultimo_mes_vivienda.nlargest(5, "variacion")
    top_disminucion_provincias = ultimo_mes_vivienda.nsmallest(5, "variacion")

    # Concatenar para un gr√°fico comparativo
    top_variacion_provincias = pd.concat(
        [top_aumento_provincias, top_disminucion_provincias]
    )
    st.markdown("")
    # Visualizaci√≥n de las m√©tricas y explicaciones
    st.header(f"An√°lisis para: {producto_tipo}")
    st.markdown("")
    # M√©tricas con tarjetas (Cards) explicadas
    st.subheader("üè∑Ô∏è Provincias clave", divider="blue")
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        with st.container(border=True):
            st.metric(
                label="Provincia m√°s cara",
                value=f"{provincia_mas_cara['provincia']}",
                delta=f"{provincia_mas_cara['precio']:.2f}‚Ç¨",
                help=f"Esta es la provincia m√°s cara para {producto_tipo} en el periodo seleccionado.",
            )

    with col2:
        with st.container(border=True):
            st.metric(
                label="Provincia m√°s barata",
                value=f"{provincia_mas_barata['provincia']}",
                delta=f"{provincia_mas_barata['precio']:.2f}‚Ç¨",
                help=f"Esta es la provincia m√°s barata para {producto_tipo} en el mismo periodo.",
            )

    with col3:
        with st.container(border=True):
            st.metric(
                label="Mayor aumento de precio",
                value=f"{provincia_mayor_aumento['provincia']}",
                delta=f"{provincia_mayor_aumento['diferencia']:.2f}‚Ç¨",
                help="Esta provincia ha tenido el mayor aumento de precios.",
            )

    with col4:
        with st.container(border=True):
            st.metric(
                label="Mayor disminuci√≥n de precio",
                value=f"{provincia_mayor_disminucion['provincia']}",
                delta=f"{provincia_mayor_disminucion['diferencia']:.2f}‚Ç¨",
                help="Esta provincia ha tenido el mayor diminuci√≥n de precios.",
            )

    # Filtrar los datos por tipo de producto (venta o alquiler) y rango de fechas
    df_vivienda_filtrado = vivienda_df[
        (vivienda_df["producto"] == producto_tipo)
        & (vivienda_df["fecha"] >= pd.to_datetime(fecha_inicio_vivienda))
        & (vivienda_df["fecha"] <= pd.to_datetime(fecha_fin_vivienda))
    ]

    # Agrupar los precios promedio por provincia
    precios_promedio_provincia = (
        df_vivienda_filtrado.groupby("provincia")["precio"].mean().reset_index()
    )

    # Descargar el geojson de las provincias de Espa√±a para el mapa
    geojson_url = "https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/spain-provinces.geojson"
    response = requests.get(geojson_url)
    geojson_provincias = response.json()

    # Mostrar mapa en Streamlit
    col1, col2 = st.columns(2)
    with col1:
        # Crear mapa coropl√©tico con Folium
        st.subheader("üåç Precios por Provincias en Mapa Coropl√©tico")

        # Crear el mapa base centrado en Espa√±a
        mapa = folium.Map(
            location=[40.4168, -3.7038], zoom_start=6, tiles="cartodb positron"
        )

        # A√±adir capa de Choropleth (Mapa Coropl√©tico)
        folium.Choropleth(
            geo_data=geojson_provincias,
            name="choropleth",
            data=precios_promedio_provincia,
            columns=["provincia", "precio"],
            key_on="feature.properties.name",  # Aseg√∫rate de que 'name' coincide con las provincias
            fill_color="YlGnBu",
            fill_opacity=0.7,
            line_opacity=0.2,
            legend_name="Precio promedio (‚Ç¨)",
        ).add_to(mapa)
        st_data = st_folium(mapa, width=700)

    # Gr√°fico de barras con precios por provincia
    with col2:
        st.subheader(" üìä Provincias ordenadas por precio promedio")
        fig_bar_provincias = px.bar(
            precios_promedio_provincia.sort_values("precio", ascending=False),
            x="provincia",
            y="precio",
            color="precio",
            title="Provincias ordenadas por precio promedio",
            labels={"precio": "Precio promedio (‚Ç¨)", "provincia": "Provincia"},
            color_continuous_scale=px.colors.sequential.Blues,
        )
        fig_bar_provincias.update_layout(
            yaxis_title="Precio promedio (‚Ç¨)", xaxis_title="Provincia", height=650
        )
        st.plotly_chart(fig_bar_provincias, use_container_width=True)

        # Gr√°fico de barras para las provincias con mayor variaci√≥n
    st.subheader(
        "üìä Provincias que m√°s han subido y bajado en precio en el √∫ltimo mes",
        divider="blue",
    )
    fig_variacion_provincias = px.bar(
        top_variacion_provincias,
        x="provincia",
        y="variacion",
        color="variacion",
        labels={"variacion": "Cambio porcentual (%)", "provincia": "Provincia"},
        color_continuous_scale=["red", "green"],
    )
    fig_variacion_provincias.update_layout(
        barmode="group", yaxis_title="Cambio porcentual (%)", xaxis_title="Provincia"
    )
    st.plotly_chart(fig_variacion_provincias, use_container_width=True)
